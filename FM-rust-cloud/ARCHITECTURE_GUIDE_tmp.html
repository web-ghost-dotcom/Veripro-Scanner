<!DOCTYPE html>
<html>
<head>
<title>ARCHITECTURE_GUIDE.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="cbse-architecture-guide-complete-blockchain-symbolic-execution">CBSE Architecture Guide: Complete Blockchain Symbolic Execution</h1>
<h2 id="overview">Overview</h2>
<p>CBSE (Complete Blockchain Symbolic Executor) is a Rust-based symbolic execution engine for Ethereum smart contracts. It analyzes Solidity code by exploring all possible execution paths to find vulnerabilities, assertion failures, and edge cases that traditional testing might miss.</p>
<hr>
<h2 id="key-capabilities">Key Capabilities</h2>
<ul>
<li><strong>Symbolic Execution</strong>: Explores all code paths using symbolic values instead of concrete inputs</li>
<li><strong>Automatic Bug Detection</strong>: Finds overflows, underflows, assertion failures, and reverts</li>
<li><strong>Path Exploration</strong>: Discovers counterexamples that violate invariants</li>
<li><strong>Dual Execution Modes</strong>: Run locally or offload to remote cloud servers via SSH</li>
</ul>
<hr>
<h2 id="core-philosophy">Core Philosophy</h2>
<p><strong>Traditional Testing:</strong></p>
<pre class="hljs"><code><div>test(5) ‚úì  test(10) ‚úì  test(100) ‚úì  ... (limited coverage)
</div></code></pre>
<p><strong>Symbolic Execution:</strong></p>
<pre class="hljs"><code><div>test(X) where X ‚àà [0, 2^256-1]  (complete coverage)
</div></code></pre>
<hr>
<h2 id="execution-modes">Execution Modes</h2>
<h3 id="1-local-mode-default">1. Local Mode (Default)</h3>
<p>Execute everything on your local machine:</p>
<pre class="hljs"><code><div>cbse --<span class="hljs-keyword">function</span> <span class="hljs-string">"test"</span>
</div></code></pre>
<p><strong>Use Cases:</strong></p>
<ul>
<li>Development and debugging</li>
<li>Small to medium contracts</li>
<li>Quick iteration cycles</li>
<li>No network latency concerns</li>
</ul>
<h3 id="2-ssh-cloud-mode">2. SSH Cloud Mode</h3>
<p>Compile locally, execute remotely:</p>
<pre class="hljs"><code><div>cbse --ssh --ssh-host node10@node10 --<span class="hljs-keyword">function</span> <span class="hljs-string">"test"</span>
</div></code></pre>
<p><strong>Use Cases:</strong></p>
<ul>
<li>Large contract suites requiring heavy computation</li>
<li>Offloading Z3 solver work to powerful servers</li>
<li>Parallel execution across multiple nodes (future)</li>
<li>Resource-constrained local machines</li>
</ul>
<hr>
<h2 id="system-architecture-overview">System Architecture Overview</h2>
<pre><code class="language-mermaid"><div class="mermaid">graph TD
    A[Solidity Code<br/>.sol files]
    A --> B[PHASE 1: COMPILATION<br/>Always happens locally]
    B --> C[cbse-build<br/>Forge Integration]
    C --> D[Build Artifact<br/>‚Ä¢ Bytecode<br/>‚Ä¢ ABI<br/>‚Ä¢ Storage<br/>‚Ä¢ Metadata]
    
    D --> E{Execution Mode?}
    
    E -->|Local| L1[LOCAL EXECUTION]
    E -->|SSH| S1[SSH CLOUD MODE]
    
    S1 --> S2[cbse-remote<br/>SSH Upload]
    S2 --> S3[Remote Server<br/>Worker Mode]
    
    L1 --> P2[PHASE 2:<br/>SYMBOLIC EXECUTION]
    S3 --> P2
    
    P2 --> J[cbse-sevm<br/>Symbolic EVM]
    J --> K[Path Exploration<br/>‚Ä¢ Fork on branch<br/>‚Ä¢ Track paths<br/>‚Ä¢ Collect traces]
    K --> L[cbse-solver Z3<br/>Constraint Solving]
    L --> M[Test Results<br/>‚Ä¢ Pass/Fail<br/>‚Ä¢ Traces<br/>‚Ä¢ Counterexample]
    
    M --> N1{Mode?}
    N1 -->|Local| N2[Display Locally<br/>cbse-ui]
    N1 -->|SSH| N3[Download Results<br/>cbse-remote]
    N3 --> N2
    
    style A fill:#e1f5ff
    style D fill:#fff4e1
    style P2 fill:#ffe1f5
    style M fill:#e1ffe1
    style N2 fill:#f0f0f0
</div></code></pre>
<hr>
<h2 id="execution-flow">Execution Flow</h2>
<h3 id="phase-1-compilation-always-local">Phase 1: Compilation (Always Local)</h3>
<pre><code class="language-mermaid"><div class="mermaid">graph TD
    U[User runs: cbse --function test]
    U --> C1[cbse-config<br/>Parse CLI arguments]
    C1 --> B1[cbse-build executes<br/>forge build --ast<br/>--extra-output storageLayout]
    B1 --> F1[Forge compiles<br/>Solidity contracts]
    F1 --> F2[test/Counter.t.sol ‚Üí<br/>out/Counter.t.sol/CounterTest.json]
    F2 --> F3[src/Counter.sol ‚Üí<br/>out/Counter.sol/Counter.json]
    F3 --> P1[cbse-build parses<br/>JSON artifacts]
    P1 --> A1[BuildArtifacts struct<br/>‚Ä¢ abi: Array<br/>‚Ä¢ bytecode: Hex<br/>‚Ä¢ deployedBytecode: Hex<br/>‚Ä¢ storageLayout: Object<br/>‚Ä¢ metadata: Object]
    
    style U fill:#e1f5ff
    style A1 fill:#e1ffe1
</div></code></pre>
<hr>
<h3 id="phase-2a-local-execution-flow">Phase 2A: Local Execution Flow</h3>
<pre><code class="language-mermaid"><div class="mermaid">graph TD
    START[Start Local Execution]
    START --> INIT[Initialize SEVM<br/>‚Ä¢ Create Z3 context<br/>‚Ä¢ Create initial State<br/>‚Ä¢ Load bytecode]
    
    INIT --> DEPLOY1[Deploy Test Contract<br/>‚Ä¢ Create symbolic address<br/>‚Ä¢ Store bytecode<br/>‚Ä¢ Setup environment]
    
    DEPLOY1 --> DEPLOY2[Deploy Target Contracts<br/>‚Ä¢ Deploy Counter.sol<br/>‚Ä¢ Run constructor<br/>‚Ä¢ Store bytecode]
    
    DEPLOY2 --> BUILD[Build Function Call<br/>‚Ä¢ Calculate selector<br/>‚Ä¢ Encode symbolic args<br/>‚Ä¢ Create calldata]
    
    BUILD --> EXEC[Execute Test Function<br/>Start SEVM Loop]
    
    EXEC --> OP1[OPCODE: PUSH1 0x80<br/>Create symbolic value<br/>Push to stack]
    
    OP1 --> OP2[OPCODE: MSTORE<br/>Update memory offset]
    
    OP2 --> OP3[OPCODE: CALLDATALOAD<br/>Load symbolic x from calldata]
    
    OP3 --> OP4[OPCODE: SSTORE<br/>Storage contract 0 = symbolic x]
    
    OP4 --> BRANCH{OPCODE: JUMPI<br/>Conditional Branch?}
    
    BRANCH -->|True| PATH1[Path 1:<br/>branch_condition == true<br/>Add constraint]
    BRANCH -->|False| PATH2[Path 2:<br/>branch_condition == false<br/>Add constraint]
    
    PATH1 --> SAT1{Z3 SAT Check<br/>Path 1}
    PATH2 --> SAT2{Z3 SAT Check<br/>Path 2}
    
    SAT1 -->|SAT| CONT1[Continue<br/>Execution Path 1]
    SAT1 -->|UNSAT| PRUNE1[Prune Path 1<br/>Infeasible]
    
    SAT2 -->|SAT| CONT2[Continue<br/>Execution Path 2]
    SAT2 -->|UNSAT| PRUNE2[Prune Path 2<br/>Infeasible]
    
    CONT1 --> CHECK1{Assertion/Revert?}
    CONT2 --> CHECK2{Assertion/Revert?}
    
    CHECK1 -->|Yes| FAIL1[REVERT Detected<br/>Record trace<br/>Extract counterexample]
    CHECK1 -->|No| PASS1[Continue to completion]
    
    CHECK2 -->|Yes| FAIL2[REVERT Detected<br/>Record trace<br/>Extract counterexample]
    CHECK2 -->|No| PASS2[Continue to completion]
    
    FAIL1 --> RESULT[Aggregate Test Results]
    FAIL2 --> RESULT
    PASS1 --> RESULT
    PASS2 --> RESULT
    PRUNE1 --> RESULT
    PRUNE2 --> RESULT
    
    RESULT --> UI[Display in Terminal<br/>cbse-ui<br/>‚Ä¢ Passed tests<br/>‚Ä¢ Failed tests<br/>‚Ä¢ Counterexamples]
    
    style START fill:#e1f5ff
    style BRANCH fill:#ffe1e1
    style SAT1 fill:#fff4e1
    style SAT2 fill:#fff4e1
    style FAIL1 fill:#ffcccc
    style FAIL2 fill:#ffcccc
    style UI fill:#e1ffe1
</div></code></pre>
<hr>
<h3 id="phase-2b-ssh-cloud-execution-flow">Phase 2B: SSH Cloud Execution Flow</h3>
<pre><code class="language-mermaid"><div class="mermaid">graph TD
    START[User runs: cbse --ssh<br/>--ssh-host user@server<br/>--function test]
    
    START --> LOCAL1[LOCAL: Compilation<br/>Steps 1-3 same as local mode]
    
    LOCAL1 --> LOCAL2[LOCAL: cbse-remote<br/>Create JobArtifact]
    
    LOCAL2 --> JOB[JobArtifact Structure:<br/>‚Ä¢ contracts array<br/>‚Ä¢ config object<br/>‚Ä¢ job_id uuid<br/>‚Ä¢ timestamp]
    
    JOB --> SERIAL[Serialize to<br/>artifact.json]
    
    SERIAL --> CONN[LOCAL: Establish<br/>SSH Connection<br/>‚Ä¢ Prompt for password<br/>‚Ä¢ TCP connection<br/>‚Ä¢ Authentication]
    
    CONN --> UPLOAD[LOCAL: SFTP Upload<br/>artifact.json ‚Üí<br/>/tmp/cbse-jobs/uuid/]
    
    UPLOAD --> EXEC[LOCAL: Execute<br/>Remote Command<br/>/usr/local/bin/cbse<br/>--worker-mode<br/>--input artifact.json<br/>--output result.json]
    
    EXEC --> REMOTE1[REMOTE: Worker Mode Starts]
    
    REMOTE1 --> REMOTE2[REMOTE: Deserialize<br/>artifact.json]
    
    REMOTE2 --> REMOTE3[REMOTE: Initialize<br/>Z3 Context]
    
    REMOTE3 --> REMOTE4[REMOTE: Execute Tests<br/>Same as Local Phase 2A<br/>Steps 2-4]
    
    REMOTE4 --> REMOTE5[REMOTE: Symbolic<br/>Execution Loop<br/>‚Ä¢ Deploy contracts<br/>‚Ä¢ Execute functions<br/>‚Ä¢ Fork paths<br/>‚Ä¢ Check constraints<br/>‚Ä¢ Collect results]
    
    REMOTE5 --> REMOTE6[REMOTE: Serialize Results<br/>to result.json]
    
    REMOTE6 --> RESULT[Result JSON:<br/>‚Ä¢ tests array<br/>‚Ä¢ passed boolean<br/>‚Ä¢ traces<br/>‚Ä¢ counterexamples<br/>‚Ä¢ summary]
    
    RESULT --> EXIT[REMOTE: Exit Worker<br/>Code 0 pass or 1 fail]
    
    EXIT --> DOWNLOAD[LOCAL: SFTP Download<br/>result.json from<br/>/tmp/cbse-jobs/uuid/]
    
    DOWNLOAD --> CLEANUP[LOCAL: Remote Cleanup<br/>rm -rf /tmp/cbse-jobs/uuid/]
    
    CLEANUP --> PARSE[LOCAL: Parse<br/>result.json]
    
    PARSE --> DISPLAY[LOCAL: Display Results<br/>cbse-ui<br/>Same as local mode]
    
    style START fill:#e1f5ff
    style LOCAL1 fill:#e1f5ff
    style LOCAL2 fill:#e1f5ff
    style CONN fill:#fff4e1
    style UPLOAD fill:#ffe1f5
    style REMOTE1 fill:#ffe1e1
    style REMOTE2 fill:#ffe1e1
    style REMOTE3 fill:#ffe1e1
    style REMOTE4 fill:#ffe1e1
    style REMOTE5 fill:#ffe1e1
    style REMOTE6 fill:#ffe1e1
    style DOWNLOAD fill:#ffe1f5
    style DISPLAY fill:#e1ffe1
</div></code></pre>
<hr>
<h2 id="data-flow-diagrams">Data Flow Diagrams</h2>
<h3 id="local-mode-data-flow-vertical">Local Mode Data Flow (Vertical)</h3>
<pre><code class="language-mermaid"><div class="mermaid">graph TD
    A[Solidity Source Files<br/>.sol]
    
    A -->|cbse-build| B[BuildArtifacts]
    
    B1[BuildArtifacts Contents:<br/>‚Ä¢ bytecode: Vec u8<br/>‚Ä¢ abi: Vec AbiItem<br/>‚Ä¢ storage: StorageLayout]
    B --> B1
    
    B1 -->|main.rs| C[Iterate Each Test Function]
    
    C -->|cbse-sevm| D[SEVM Initialization]
    
    D1[SEVM Components:<br/>‚Ä¢ Context Z3<br/>‚Ä¢ State stack, memory, storage<br/>‚Ä¢ Contract bytecode]
    D --> D1
    
    D1 -->|cbse-calldata| E[Build Function Call]
    
    E1[Function Call:<br/>‚Ä¢ selector: u8; 4<br/>‚Ä¢ args: Vec CbseBitVec]
    E --> E1
    
    E1 -->|cbse-sevm opcodes| F[Execution Loop]
    
    F --> G{Conditional Branch?}
    
    G -->|Yes| H[Path 1<br/>Constraints:<br/>Vec Z3Bool]
    G -->|Yes| I[Path 2<br/>Constraints:<br/>Vec Z3Bool]
    G -->|No| J[Continue Single Path]
    
    H -->|cbse-solver| K{SAT Check Path 1}
    I -->|cbse-solver| L{SAT Check Path 2}
    J -->|cbse-solver| M{SAT Check}
    
    K -->|SAT| N[Continue Path 1]
    K -->|UNSAT| O[Prune Path 1]
    
    L -->|SAT| P[Continue Path 2]
    L -->|UNSAT| Q[Prune Path 2]
    
    M -->|SAT| R[Continue]
    M -->|UNSAT| S[Prune]
    
    N -->|cbse-traces| T[Trace Recording]
    P -->|cbse-traces| T
    R -->|cbse-traces| T
    
    T1[Trace Events:<br/>‚Ä¢ CALL<br/>‚Ä¢ SLOAD<br/>‚Ä¢ SSTORE<br/>‚Ä¢ REVERT]
    T --> T1
    
    T1 -->|main.rs| U[TestResult]
    
    U1[TestResult:<br/>‚Ä¢ passed: bool<br/>‚Ä¢ trace: String<br/>‚Ä¢ counterexample: Option Model]
    U --> U1
    
    U1 -->|cbse-ui| V[Terminal Output<br/>Formatted Display]
    
    style A fill:#e1f5ff
    style B1 fill:#fff4e1
    style D1 fill:#ffe1f5
    style E1 fill:#e1ffe1
    style G fill:#ffcccc
    style K fill:#fff4e1
    style L fill:#fff4e1
    style M fill:#fff4e1
    style T1 fill:#e1f5ff
    style U1 fill:#ffe1e1
    style V fill:#e1ffe1
</div></code></pre>
<hr>
<h3 id="ssh-cloud-mode-data-flow-vertical">SSH Cloud Mode Data Flow (Vertical)</h3>
<pre><code class="language-mermaid"><div class="mermaid">graph TD
    subgraph LOCAL[" "]
        A[Solidity Source<br/>Local Machine]
        A --> B[cbse-build<br/>Compilation]
        B --> C[BuildArtifacts<br/>Local]
        C --> D[cbse-remote<br/>Job Creation]
        D --> E[JobArtifact Object<br/>‚Ä¢ contracts<br/>‚Ä¢ config<br/>‚Ä¢ metadata]
        E --> F[Serialize to<br/>artifact.json]
        F --> G[SFTP Upload<br/>SSH Connection]
    end
    
    G -.Transfer.-> H
    
    subgraph REMOTE[" "]
        H[artifact.json<br/>Remote Server]
        H --> I[cbse --worker-mode<br/>Deserialize]
        I --> J[Initialize<br/>Z3 Context]
        J --> K[cbse-sevm<br/>Execution Loop]
        K --> L[Path Exploration<br/>Fork & Track]
        L --> M[cbse-solver<br/>Constraint Solving]
        M --> N[Collect Results<br/>Traces & Counterexamples]
        N --> O[Serialize to<br/>result.json]
    end
    
    O -.Transfer.-> P
    
    subgraph LOCAL2[" "]
        P[SFTP Download<br/>result.json]
        P --> Q[JobResult Object<br/>Local Machine]
        Q --> R[Parse Results<br/>Test Outcomes]
        R --> S[cbse-ui<br/>Terminal Display]
        S --> T[Formatted Output<br/>‚Ä¢ Passed Tests<br/>‚Ä¢ Failed Tests<br/>‚Ä¢ Counterexamples<br/>‚Ä¢ Summary]
    end
    
    style A fill:#e1f5ff
    style C fill:#fff4e1
    style E fill:#ffe1f5
    style G fill:#ffcccc
    style H fill:#ffe1e1
    style K fill:#ffe1e1
    style M fill:#ffe1e1
    style O fill:#ffcccc
    style P fill:#e1ffe1
    style S fill:#e1f5ff
    style T fill:#ccffcc
</div></code></pre>
<hr>
<h2 id="worker-mode-json-structure">Worker Mode JSON Structure</h2>
<h3 id="artifactjson-uploaded-to-remote">artifact.json (Uploaded to Remote)</h3>
<pre class="hljs"><code><div>{
  <span class="hljs-attr">"contracts"</span>: [
    {
      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"Counter"</span>,
      <span class="hljs-attr">"bytecode"</span>: <span class="hljs-string">"0x608060405234801561001057600080fd5b50..."</span>,
      <span class="hljs-attr">"abi"</span>: [
        {
          <span class="hljs-attr">"type"</span>: <span class="hljs-string">"function"</span>,
          <span class="hljs-attr">"name"</span>: <span class="hljs-string">"increment"</span>,
          <span class="hljs-attr">"inputs"</span>: [],
          <span class="hljs-attr">"outputs"</span>: []
        }
      ],
      <span class="hljs-attr">"test_functions"</span>: [<span class="hljs-string">"test_Increment"</span>, <span class="hljs-string">"testFuzz_SetNumber"</span>]
    }
  ],
  <span class="hljs-attr">"config"</span>: {
    <span class="hljs-attr">"verbosity"</span>: <span class="hljs-number">3</span>,
    <span class="hljs-attr">"debug"</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">"print_setup_states"</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">"print_traces"</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">"solver_timeout_ms"</span>: <span class="hljs-number">30000</span>,
    <span class="hljs-attr">"solver_max_memory"</span>: <span class="hljs-number">8192</span>,
    <span class="hljs-attr">"loop_bound"</span>: <span class="hljs-number">3</span>,
    <span class="hljs-attr">"width_bound"</span>: <span class="hljs-number">5</span>,
    <span class="hljs-attr">"depth_bound"</span>: <span class="hljs-number">100</span>,
    <span class="hljs-attr">"array_lengths"</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">"symbolic_storage"</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">"symbolic_msg_sender"</span>: <span class="hljs-literal">false</span>
  },
  <span class="hljs-attr">"job_id"</span>: <span class="hljs-string">"a1b2c3d4-e5f6-7890-abcd-ef1234567890"</span>,
  <span class="hljs-attr">"timestamp"</span>: <span class="hljs-string">"2025-11-07T10:30:15Z"</span>
}
</div></code></pre>
<h3 id="resultjson-downloaded-from-remote">result.json (Downloaded from Remote)</h3>
<pre class="hljs"><code><div>{
  <span class="hljs-attr">"tests"</span>: [
    {
      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"CounterTest::test_Increment()"</span>,
      <span class="hljs-attr">"passed"</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">"gas_used"</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">"return_data"</span>: <span class="hljs-string">""</span>,
      <span class="hljs-attr">"trace"</span>: <span class="hljs-string">"CALL 0xabcd1234::0x273a7c12() (caller: 0x12345678)\n‚Ü© RETURN 0x"</span>,
      <span class="hljs-attr">"counterexample"</span>: <span class="hljs-literal">null</span>
    },
    {
      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"CounterTest::testFuzz_SetNumber(uint256)"</span>,
      <span class="hljs-attr">"passed"</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">"gas_used"</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">"return_data"</span>: <span class="hljs-string">"0x4e487b71..."</span>,
      <span class="hljs-attr">"trace"</span>: <span class="hljs-string">"CALL 0xabcd1234::0xabc12345() (caller: 0x12345678)\n‚Ü© REVERT 0x4e487b71..."</span>,
      <span class="hljs-attr">"counterexample"</span>: {
        <span class="hljs-attr">"x"</span>: <span class="hljs-string">"115792089237316195423570985008687907853269984665640564039457584007913129639935"</span>
      }
    }
  ],
  <span class="hljs-attr">"summary"</span>: {
    <span class="hljs-attr">"total"</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">"passed"</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">"failed"</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">"execution_time_ms"</span>: <span class="hljs-number">4523</span>
  }
}
</div></code></pre>
<hr>
<h2 id="user-guide">User Guide</h2>
<h3 id="installation">Installation</h3>
<h4 id="prerequisites">Prerequisites</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># Install Rust</span>
curl --proto <span class="hljs-string">'=https'</span> --tlsv1.2 -sSf https://sh.rustup.rs | sh

<span class="hljs-comment"># Install Foundry (for Forge)</span>
curl -L https://foundry.paradigm.xyz | bash
foundryup

<span class="hljs-comment"># Install Z3 SMT Solver</span>
<span class="hljs-comment"># macOS:</span>
brew install z3

<span class="hljs-comment"># Ubuntu/Debian:</span>
sudo apt-get install z3 libz3-dev

<span class="hljs-comment"># Fedora:</span>
sudo dnf install z3 z3-devel
</div></code></pre>
<h4 id="build-cbse">Build CBSE</h4>
<pre class="hljs"><code><div>git <span class="hljs-built_in">clone</span> https://github.com/leojay-net/FM-Rust-Cloud.git
<span class="hljs-built_in">cd</span> FM-rust-cloud
cargo build --release
cargo install --path crates/cbse
</div></code></pre>
<hr>
<h3 id="local-execution">Local Execution</h3>
<h4 id="basic-usage">Basic Usage</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># Navigate to your Foundry project</span>
<span class="hljs-built_in">cd</span> my-project

<span class="hljs-comment"># Run all tests</span>
cbse --<span class="hljs-keyword">function</span> <span class="hljs-string">"test"</span>

<span class="hljs-comment"># Run specific test</span>
cbse --<span class="hljs-keyword">function</span> <span class="hljs-string">"testFuzz_SetNumber"</span>

<span class="hljs-comment"># Run with verbose output</span>
cbse --<span class="hljs-keyword">function</span> <span class="hljs-string">"test"</span> -vvv

<span class="hljs-comment"># Run with debugging</span>
cbse --<span class="hljs-keyword">function</span> <span class="hljs-string">"test"</span> --debug --<span class="hljs-built_in">print</span>-traces
</div></code></pre>
<h4 id="configuration-options">Configuration Options</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># Solver settings</span>
cbse --<span class="hljs-keyword">function</span> <span class="hljs-string">"test"</span> \
  --solver-timeout-ms 60000 \
  --solver-max-memory 16384

<span class="hljs-comment"># Exploration bounds</span>
cbse --<span class="hljs-keyword">function</span> <span class="hljs-string">"test"</span> \
  --loop 5 \
  --width 10 \
  --depth 200

<span class="hljs-comment"># Symbolic configuration</span>
cbse --<span class="hljs-keyword">function</span> <span class="hljs-string">"test"</span> \
  --symbolic-storage \
  --symbolic-msg-sender

<span class="hljs-comment"># Array lengths</span>
cbse --<span class="hljs-keyword">function</span> <span class="hljs-string">"test"</span> \
  --array-lengths <span class="hljs-string">"MyArray=5,OtherArray=10"</span>
</div></code></pre>
<hr>
<h3 id="ssh-cloud-execution">SSH Cloud Execution</h3>
<h4 id="setup-remote-server">Setup Remote Server</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># 1. SSH into your remote server</span>
ssh user@remote-server

<span class="hljs-comment"># 2. Install dependencies</span>
sudo apt-get update
sudo apt-get install -y build-essential pkg-config libssl-dev z3 libz3-dev clang

<span class="hljs-comment"># 3. Install Rust</span>
curl --proto <span class="hljs-string">'=https'</span> --tlsv1.2 -sSf https://sh.rustup.rs | sh
<span class="hljs-built_in">source</span> <span class="hljs-variable">$HOME</span>/.cargo/env

<span class="hljs-comment"># 4. Clone and install CBSE</span>
git <span class="hljs-built_in">clone</span> https://github.com/leojay-net/FM-Rust-Cloud.git
<span class="hljs-built_in">cd</span> FM-rust-cloud
cargo install --path crates/cbse

<span class="hljs-comment"># 5. Create symlink (optional)</span>
sudo ln -s ~/.cargo/bin/cbse /usr/<span class="hljs-built_in">local</span>/bin/cbse

<span class="hljs-comment"># 6. Verify installation</span>
cbse --version
</div></code></pre>
<h4 id="run-tests-on-remote-server">Run Tests on Remote Server</h4>
<pre class="hljs"><code><div><span class="hljs-comment"># From your local machine</span>
<span class="hljs-built_in">cd</span> my-project

<span class="hljs-comment"># Run on remote server</span>
cbse --ssh --ssh-host user@remote-server --<span class="hljs-keyword">function</span> <span class="hljs-string">"test"</span>

<span class="hljs-comment"># With custom port</span>
cbse --ssh --ssh-host user@remote-server --ssh-port 2222 --<span class="hljs-keyword">function</span> <span class="hljs-string">"test"</span>

<span class="hljs-comment"># With verbose output</span>
cbse --ssh --ssh-host user@remote-server --<span class="hljs-keyword">function</span> <span class="hljs-string">"test"</span> -vvv

<span class="hljs-comment"># All configuration options work with SSH</span>
cbse --ssh --ssh-host user@remote-server \
  --<span class="hljs-keyword">function</span> <span class="hljs-string">"test"</span> \
  --solver-timeout-ms 120000 \
  --loop 10 \
  --debug
</div></code></pre>
<hr>
<h3 id="how-ssh-mode-works-step-by-step">How SSH Mode Works (Step by Step)</h3>
<pre><code class="language-mermaid"><div class="mermaid">graph TD
    S1[Step 1:<br/>Local Compilation<br/>Forge builds contracts]
    S1 --> S2[Step 2:<br/>Artifact Upload<br/>SFTP transfer bytecode + config]
    S2 --> S3[Step 3:<br/>Remote Execution<br/>CBSE runs symbolic analysis]
    S3 --> S4[Step 4:<br/>Result Download<br/>SFTP transfer results back]
    S4 --> S5[Step 5:<br/>Cleanup<br/>Remove temp files from remote]
    S5 --> S6[Step 6:<br/>Display Results<br/>Show in local terminal]
    
    style S1 fill:#e1f5ff
    style S2 fill:#ffe1f5
    style S3 fill:#ffe1e1
    style S4 fill:#e1ffe1
    style S5 fill:#fff4e1
    style S6 fill:#ccffcc
</div></code></pre>
<p><strong>Advantages:</strong></p>
<ul>
<li>No need to sync source code to remote</li>
<li>No need to install Forge on remote</li>
<li>Only bytecode is transferred (small payload)</li>
<li>Full config control from local CLI</li>
<li>Results displayed locally with same UI</li>
</ul>
<hr>
<h3 id="monitoring-remote-execution">Monitoring Remote Execution</h3>
<p>On the remote server, you can monitor CBSE execution:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># Monitor active processes</span>
watch -n 1 <span class="hljs-string">'ps aux | grep cbse'</span>

<span class="hljs-comment"># Monitor job directories</span>
watch -n 1 <span class="hljs-string">'ls -lh /tmp/cbse-jobs/'</span>

<span class="hljs-comment"># View logs (if CBSE is verbose)</span>
tail -f /tmp/cbse-jobs/*/output.log
</div></code></pre>
<hr>
<h2 id="example-workflow-finding-a-bug-in-simplevault">Example Workflow: Finding a Bug in SimpleVault</h2>
<h3 id="contract-code">Contract Code</h3>
<pre class="hljs"><code><div>// src/SimpleVault.sol
contract SimpleVault {
    mapping(address =&gt; uint256) public balances;

    function deposit() external payable {
        balances[msg.sender] += msg.value;
    }

    function withdraw(uint256 amount) external {
        require(balances[msg.sender] &gt;= amount, &quot;Insufficient balance&quot;);
        balances[msg.sender] -= amount;  // BUG: Should happen AFTER transfer
        payable(msg.sender).transfer(amount);
    }
}
</div></code></pre>
<h3 id="test-code">Test Code</h3>
<pre class="hljs"><code><div>// test/SimpleVault.t.sol
contract SimpleVaultTest is Test {
    SimpleVault vault;

    function setUp() public {
        vault = new SimpleVault();
    }

    function testWithdraw(uint256 depositAmount, uint256 withdrawAmount) public {
        vm.assume(depositAmount &gt; 0);
        vm.assume(withdrawAmount &gt; 0);
        
        vault.deposit{value: depositAmount}();
        vault.withdraw(withdrawAmount);
        
        // This should hold, but CBSE will find a counterexample
        assert(address(vault).balance &gt;= 0);
    }
}
</div></code></pre>
<hr>
<h3 id="local-execution-output">Local Execution Output</h3>
<pre class="hljs"><code><div>$ cbse --function &quot;testWithdraw&quot; -vvv

   ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
   ‚ïë  CBSE - Complete Blockchain Symbolic     ‚ïë
   ‚ïë         Executor (Rust Edition)           ‚ïë
   ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

  Executing testWithdraw(uint256,uint256)
    
    ‚úó Counterexample found!
    
    Symbolic inputs:
      depositAmount = 100
      withdrawAmount = 200
    
    Trace:
    CALL SimpleVault::deposit() value=100
      SSTORE balances[caller] = 100
    ‚Ü© RETURN
    
    CALL SimpleVault::withdraw(200)
      SLOAD balances[caller] ‚Üí 100
      ‚úì require(100 &gt;= 200)  ‚Üê FAILS
    ‚Ü© REVERT &quot;Insufficient balance&quot;

Summary: 1 test, 0 passed, 1 failed
</div></code></pre>
<hr>
<h3 id="ssh-execution-output-same-contract">SSH Execution Output (Same Contract)</h3>
<pre class="hljs"><code><div>$ cbse --ssh --ssh-host compute-node --function &quot;testWithdraw&quot; -vvv

Running in SSH mode (remote execution)
Enter SSH password: ****
üîå Connecting to compute-node:22...
‚úÖ SSH connection established
üì§ Uploading artifacts...
‚öôÔ∏è  Executing CBSE on remote node...

üìã Remote output:
   ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
   ‚ïë  CBSE - Complete Blockchain Symbolic     ‚ïë
   ‚ïë         Executor (Rust Edition)           ‚ïë
   ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

  Executing testWithdraw(uint256,uint256)
    
    ‚úó Counterexample found!
    
    Symbolic inputs:
      depositAmount = 100
      withdrawAmount = 200
    
    [... same trace as local ...]

üì• Downloading results...
‚úÖ Remote execution complete in 3.45s

Summary: 1 test, 0 passed, 1 failed
</div></code></pre>
<p><strong>Identical results!</strong> The only difference is where Z3 solver runs.</p>
<hr>
<h2 id="summary">Summary</h2>
<p>CBSE provides two execution modes for Ethereum symbolic execution:</p>
<h3 id="local-mode">Local Mode</h3>
<ul>
<li><strong>Best for</strong>: Development, debugging, small contracts</li>
<li><strong>Requires</strong>: Rust, Forge, Z3</li>
<li><strong>Runs</strong>: Everything on your machine</li>
</ul>
<h3 id="ssh-cloud-mode">SSH Cloud Mode</h3>
<ul>
<li><strong>Best for</strong>: CI/CD, large contracts, resource-limited local machines</li>
<li><strong>Requires</strong>: Rust + Forge locally, CBSE + Z3 on remote</li>
<li><strong>Runs</strong>: Compile locally, execute remotely</li>
</ul>
<p>This design allows local-first development with optional cloud offloading for heavy workloads.</p>
<hr>

</body>
</html>
